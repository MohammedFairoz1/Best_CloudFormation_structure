AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  CloudFormationPoc

  SAM Template for CloudFormationPoc

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 20

Parameters:
  ApiName:
    Type: String
    Default: CloudFormationPocApi
    Description: This is CloudFormationPocApi
  AdminWebApiGatewayStageName:
    Type: String
    AllowedPattern: ^[a-z0-9A-Z]+$
    Default: QA
  UserName:
    Type: String
  Email:
    Type: String
  PhoneNo:
    Type: String
  Name:
    Type: String
  TableName: 
    Type: String
    Default: SystemConfig
  ArtifactsBucketName:
    Type: String
    Default: transactionartifacts
  CloudWatchLogsBucketName:
    Type: String
    Default: cloudwatch-logs-delivery
  S3EventBucketName:
    Type: String
    Default: sap-idoc-dev-testing
  PoolDomainName:
    Description: Domain name in set changes pipeline.
    Type: String
    Default: devCloudFormationPoc
  ACMCertificate:
    Description: ACM certificate name in set changes pipeline.
    Type: String
    Default: abcd       
  PoolDomainType:
    Description: Environment type in set changes pipeline.
    Type: String
    AllowedValues: [custom, cognito]
  Environment:
    Description: Environment type in set changes pipeline.
    Type: String
    AllowedValues: [Dev, QA, Stage, Prod]
  WebHostName:
   Type: String
   Default: connect.CloudFormationPoccloud.com
  RefreshTokenExpirationInDays:
    Type: Number
    Default: 180
    Description: The validity period of the refresh token in Days.
  AccessTokenExpirationInHours:
    Type: Number
    Default: 1
    Description: The validity period of the access token in hours.
  IdTokenExpirationInHours:
    Type: Number
    Default: 1
    Description: The validity period of the ID token in hours.
  EncryptionKey:
    Type: String
    Description: The encryption key used to encrypt the password.
  CloudFormationPocServiceApiCustomURL:
    Type: String
    Description: Custom URL for CloudFormationPoc Service API
Conditions:
  CreateCustomResources:
    Fn::Equals:
      - !Ref PoolDomainType
      - custom
  CreateCognitoResources:
    Fn::Equals:
      - !Ref PoolDomainType
      - cognito
  IsHigherEnv:
    Fn::Or:
      - Fn::Equals:
          - !Ref Environment
          - QA
      - Fn::Equals:
          - !Ref Environment
          - Stage
      - Fn::Equals:
          - !Ref Environment
          - Prod
  IsLowerEnv:
    Fn::Equals:
      - !Ref Environment
      - Dev
  IsProvisionedMode :
    Fn::Or:
      - Fn::Equals:
          - !Ref Environment
          - Stage
      - Fn::Equals:
          - !Ref Environment
          - Prod
  IsOnDemandMode:
    Fn::Or:
      - Fn::Equals:
          - !Ref Environment
          - Dev
      - Fn::Equals:
          - !Ref Environment
          - QA
Resources:
 
  ########################################################################################################################################################
  #                                                                                                                                                      # 
  #                                                        CloudFormationPoc Connect Cognito Infrastructure                                                       #
  #                                                                                                                                                      #
  ########################################################################################################################################################


  CognitoUserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: CloudFormationPocCognitoUserPool
      Policies:
        PasswordPolicy:
          MinimumLength: 10
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
          RequireUppercase: true
          TemporaryPasswordValidityDays: 7
      Schema:
        - Name: name
          AttributeDataType: String
          Mutable: true
          Required: true
        - Name: email
          AttributeDataType: String
          Mutable: false
          Required: true
        - Name: phone_number
          AttributeDataType: String
          Mutable: true
          Required: true
        - Name: Role
          AttributeDataType: String
          Mutable: true
          Required: false
        - Name: ClientId
          AttributeDataType: String
          Mutable: true
          Required: false

  CloudFormationPocCognitoOpenIdClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref CognitoUserPool
      ClientName: CloudFormationPocCognitoOpenIdClient
      GenerateSecret: true
      ExplicitAuthFlows:
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_CUSTOM_AUTH
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
      AllowedOAuthFlowsUserPoolClient: true  
      AllowedOAuthScopes: 
        - openid
        - phone 
        - email
      AuthSessionValidity: 3
      RefreshTokenValidity: 30
      AccessTokenValidity: 1
      IdTokenValidity: 1
      EnableTokenRevocation: true
      PreventUserExistenceErrors: ENABLED
      SupportedIdentityProviders: 
        - "COGNITO"
      CallbackURLs:  
         - https://*.salesforce.com
         - https://*.force.com
         - https://thalesdiscplusainc0.dev.CloudFormationPoccloud.com
         - https://rest.apisandbox3.zuora.com
      AllowedOAuthFlows:
        - "code"

  CloudFormationPocCustomHostedUICustomization:
    Type: AWS::Cognito::UserPoolDomain
    Condition: CreateCustomResources
    Properties:
      UserPoolId: !Ref CognitoUserPool
      Domain: !Ref PoolDomainName
      CustomDomainConfig:
        CertificateArn: !Ref ACMCertificate

  CloudFormationPocCognitoHostedUICustomization:
    Type: AWS::Cognito::UserPoolDomain
    Condition: CreateCognitoResources
    Properties:
      UserPoolId: !Ref CognitoUserPool
      Domain: !Ref PoolDomainName

  CognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref CognitoUserPool
      ClientName: CloudFormationPocCognitoClient
      GenerateSecret: false
      EnableTokenRevocation: true
      ExplicitAuthFlows:
        - ALLOW_ADMIN_USER_PASSWORD_AUTH
        - ALLOW_CUSTOM_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
  
  ########################################################################################################################################################
  #                                                                                                                                                      # 
  #                                                        CloudFormationPoc Connect DynamoDB Infrastructure                                                      #
  #                                                                                                                                                      #
  ########################################################################################################################################################
  ClientDynamoDBTable:
    Type: AWS::DynamoDB::Table   
    Properties:
      TableName: Client
      AttributeDefinitions:
        - AttributeName: Region
          AttributeType: S
        - AttributeName: GUID
          AttributeType: S
        - AttributeName: Name
          AttributeType: S
        - AttributeName: ServiceAccountId
          AttributeType: S
      KeySchema:
        - AttributeName: Region
          KeyType: HASH
        - AttributeName: GUID
          KeyType: RANGE
      BillingMode: 
        !If
          - IsOnDemandMode
          - PAY_PER_REQUEST
          - !Ref "AWS::NoValue"
      ProvisionedThroughput: 
        !If
          - IsProvisionedMode 
          - ReadCapacityUnits: 20
            WriteCapacityUnits: 20
          - !Ref "AWS::NoValue"

      LocalSecondaryIndexes:
        - IndexName: Region-ServiceAccountId-index
          KeySchema:
            - AttributeName: Region
              KeyType: HASH
            - AttributeName: ServiceAccountId
              KeyType: RANGE
          Projection:
            ProjectionType: ALL # Make All columns available in index
        - IndexName: Region-Name-index
          KeySchema:
            - AttributeName: Region
              KeyType: HASH
            - AttributeName: Name
              KeyType: RANGE
          Projection:
            ProjectionType: ALL # Make All columns available in index

  MessageDynamoDBTable:
    Type: AWS::DynamoDB::Table 
    Properties:
      TableName: Message
      AttributeDefinitions:
        - AttributeName: MessageType
          AttributeType: S
        - AttributeName: TimeStamp
          AttributeType: S
        - AttributeName: ClientId
          AttributeType: S
        - AttributeName: ExternalId
          AttributeType: S
      KeySchema:
        - AttributeName: MessageType
          KeyType: HASH
        - AttributeName: TimeStamp
          KeyType: RANGE
      BillingMode: 
        !If
          - IsOnDemandMode
          - PAY_PER_REQUEST
          - !Ref "AWS::NoValue"
      ProvisionedThroughput:
        !If
          - IsProvisionedMode 
          - ReadCapacityUnits: 40
            WriteCapacityUnits: 40
          - !Ref "AWS::NoValue"
      LocalSecondaryIndexes:
        - IndexName: MessageType-ClientId-index
          KeySchema:
            - AttributeName: MessageType
              KeyType: HASH
            - AttributeName: ClientId
              KeyType: RANGE
          Projection:
            ProjectionType: ALL # Make All columns available in index
        - IndexName: MessageType-ExternalId-index
          KeySchema:
            - AttributeName: MessageType
              KeyType: HASH
            - AttributeName: ExternalId
              KeyType: RANGE
          Projection:
            ProjectionType: ALL # Make All columns available in index 
      GlobalSecondaryIndexes:
        - IndexName: ClientId-TimeStamp-index
          KeySchema:
            - AttributeName: ClientId
              KeyType: HASH
            - AttributeName: TimeStamp
              KeyType: RANGE
          ProvisionedThroughput:
            !If
              - IsProvisionedMode 
              - ReadCapacityUnits: 20
                WriteCapacityUnits: 20
              - !Ref "AWS::NoValue"
          Projection:
           ProjectionType: ALL

  SystemConfigDynamoDBTable:
    Type: AWS::DynamoDB::Table 
    Properties:
      TableName: SystemConfig
      AttributeDefinitions:
        - AttributeName: System
          AttributeType: S
        - AttributeName: Version
          AttributeType: S
      KeySchema:
        - AttributeName: System
          KeyType: HASH
        - AttributeName: Version
          KeyType: RANGE
      BillingMode: 
        !If
          - IsOnDemandMode
          - PAY_PER_REQUEST
          - !Ref "AWS::NoValue"
      ProvisionedThroughput:
        !If
          - IsProvisionedMode 
          - ReadCapacityUnits: 5
            WriteCapacityUnits: 5
          - !Ref "AWS::NoValue"

  QuickTrialUserStatusDynamoDBTable:
    Type: AWS::DynamoDB::Table 
    Properties:
      TableName: QuickTrialUserStatus
      AttributeDefinitions:
        - AttributeName: UserType
          AttributeType: S
        - AttributeName: UserName
          AttributeType: S
      KeySchema:
        - AttributeName: UserType
          KeyType: HASH
        - AttributeName: UserName
          KeyType: RANGE
      BillingMode: 
        !If
          - IsOnDemandMode
          - PAY_PER_REQUEST
          - !Ref "AWS::NoValue"
      ProvisionedThroughput:
        !If
          - IsProvisionedMode 
          - ReadCapacityUnits: 5
            WriteCapacityUnits: 5
          - !Ref "AWS::NoValue"

  SchedulerLogDynamoDBTable:
    Type: AWS::DynamoDB::Table 
    Properties:
      TableName: SchedulerLog
      AttributeDefinitions:
        - AttributeName: ClientId
          AttributeType: S
        - AttributeName: TimeStamp
          AttributeType: S
      KeySchema:
        - AttributeName: ClientId
          KeyType: HASH
        - AttributeName: TimeStamp
          KeyType: RANGE
      BillingMode: 
        !If
          - IsOnDemandMode
          - PAY_PER_REQUEST
          - !Ref "AWS::NoValue"
      ProvisionedThroughput:
        !If
          - IsProvisionedMode 
          - ReadCapacityUnits: 20
            WriteCapacityUnits: 20
          - !Ref "AWS::NoValue"

  SchedulerConfigDynamoDBTable:
    Type: AWS::DynamoDB::Table 
    Properties:
      TableName: SchedulerConfig
      AttributeDefinitions:
        - AttributeName: ConfigType
          AttributeType: S
        - AttributeName: ClientId
          AttributeType: S
      KeySchema:
        - AttributeName: ConfigType
          KeyType: HASH
        - AttributeName: ClientId
          KeyType: RANGE
      BillingMode: 
        !If
          - IsOnDemandMode
          - PAY_PER_REQUEST
          - !Ref "AWS::NoValue"
      ProvisionedThroughput:
        !If
          - IsProvisionedMode 
          - ReadCapacityUnits: 20
            WriteCapacityUnits: 20
          - !Ref "AWS::NoValue"

  CallOutsDynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: CallOuts
      AttributeDefinitions:
        - AttributeType: S
          AttributeName: ClientId
        - AttributeType: S
          AttributeName: GUID
        - AttributeType: S
          AttributeName: creationDate
      GlobalSecondaryIndexes:
        - IndexName: creationDate-index
          Projection:
            ProjectionType: ALL
          KeySchema:
            - KeyType: HASH
              AttributeName: creationDate
          ProvisionedThroughput:
            !If
              - IsProvisionedMode
              - ReadCapacityUnits: 20
                WriteCapacityUnits: 20
              - !Ref "AWS::NoValue"
      KeySchema:
        - KeyType: HASH
          AttributeName: ClientId
        - KeyType: RANGE
          AttributeName: GUID
      BillingMode: 
        !If
          - IsOnDemandMode 
          - PAY_PER_REQUEST
          - !Ref "AWS::NoValue"
      ProvisionedThroughput: 
        !If
          - IsProvisionedMode
          - ReadCapacityUnits: 20
            WriteCapacityUnits: 20
          - !Ref "AWS::NoValue"

  ########################################################################################################################################################
  #                                                                                                                                                      # 
  #                                                        CloudFormationPoc Connect Policy and Role Infrastructure                                               #
  #                                                                                                                                                      #
  ########################################################################################################################################################
    
  CloudFormationPocDynamoDBAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Managed policy to allow CloudFormationPoc to access the DynamoDB tables created by this template.
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:DeleteItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:BatchGetItem
              - dynamodb:BatchWriteItem
              - dynamodb:ConditionCheckItem
              - dynamodb:GetItem
              - dynamodb:Query
              - dynamodb:Scan
            Resource:
              - !Join ["",[!GetAtt SchedulerLogDynamoDBTable.Arn]]
              - !Join ["",[!GetAtt SchedulerConfigDynamoDBTable.Arn]]
              - !Join ["",[!GetAtt ClientDynamoDBTable.Arn]]
              - !Join ["",[!GetAtt MessageDynamoDBTable.Arn]]
              - !Join ["",[!GetAtt SystemConfigDynamoDBTable.Arn]]
              - !Join ["",[!GetAtt QuickTrialUserStatusDynamoDBTable.Arn]]
              - !Join ["",[!GetAtt CallOutsDynamoDBTable.Arn]]
              - !Join ["",[!Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/Client/index/*']]
              - !Join ["",[!Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/Message/index/*']]
             

  CloudFormationPocCognitoAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Managed policy to allow CloudFormationPoc to access the Cognito UserPool created by this template.
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - cognito-idp:AdminGetUser
              - cognito-idp:AdminDeleteUser
              - cognito-idp:AdminInitiateAuth
              - cognito-idp:AdminEnableUser
              - cognito-idp:AdminCreateUser
              - cognito-idp:AdminDisableUser
              - cognito-idp:AdminUpdateUserAttributes
              - cognito-idp:AdminRespondToAuthChallenge
              - cognito-idp:ListUsers
              - cognito-idp:DescribeUserPoolClient
              - cognito-idp:UpdateUserPoolClient
              - cognito-idp:SetUICustomization
            Resource: !GetAtt CognitoUserPool.Arn

  CloudFormationPocTransactionsDetailsAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Managed policy to allow CloudFormationPoc to access the Storechartdataobjects and Getchartdata objects
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - s3:PutObject
              - s3:ListBucket
              - s3:GetObject
            Resource: !Join 
              - ''
              - - 'arn:aws:s3:::'
                - !Ref CloudFormationPocTransactionsDetails
                
  CloudFormationPocS3EventNotificationAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Managed policy to allow CloudFormationPoc to access the SAP objects
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - s3:PutObject
              - s3:ListBucket
              - s3:GetObject
              - s3:DeleteObject
              - s3:*
            Resource: !Join 
              - ''
              - - 'arn:aws:s3:::'
                - !Ref CloudFormationPocSAPEntitlement

  CloudFormationPocLogsDetailsBucketAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Managed policy to allow CloudFormationPoc to access the cloudwatchlogs to s3 bucket 
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: 
              - s3:GetBucketAcl
            Resource: !Join 
              - ''
              - - 'arn:aws:s3:::'
                - !Ref CloudFormationPocCloudwatchLogsBucket
          - Effect: Allow
            Action:
              - s3:PutObject
              - s3:GetObject
            Resource: !Join 
              - ''
              - - 'arn:aws:s3:::'
                - !Ref CloudFormationPocCloudwatchLogsBucket
                - random-string/*

  CloudFormationPocLogsDetailsAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Managed policy to allow CloudFormationPoc to access logs
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - logs:PutLogEvents
              - logs:CreateLogGroup
              - logs:PutSubscriptionFilter
              - logs:PutLogEventsBatch
              - logs:CreateLogStream
              - logs:CreateExportTask
              - logs:DescribeLogGroups
              - logs:PutResourcePolicy
              - logs:DeleteResourcePolicy
            Resource: "arn:aws:logs:*:*:*"

  CloudFormationPocSchedularInvokingEventBridgeAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Allows the associated Lambda function to manage AWS EventBridge and AWS Scheduler resources
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: events:PutTargets
            Resource: "*"
          - Effect: Allow
            Action: scheduler:CreateSchedule
            Resource: !Sub "arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/default/*"
          - Effect: Allow
            Action: scheduler:GetSchedule
            Resource: !Sub "arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/default/*"
          - Effect: Allow
            Action: scheduler:UpdateSchedule
            Resource: !Sub "arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/default/*"
          - Effect: Allow
            Action: scheduler:DeleteSchedule
            Resource: !Sub "arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/default/*"
          - Effect: Allow
            Action: iam:PassRole
            Resource: !Sub "arn:aws:iam::${AWS::AccountId}:role/${AWS::Region}CloudFormationPocSchedulerAccessRole"

  CloudFormationPocAccessRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Join [ "", [ !Ref AWS::Region, CloudFormationPocAccessRole] ]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSLambdaExecute
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/AWSLambdaInvocation-DynamoDB
        - !Ref CloudFormationPocSchedularInvokingEventBridgeAccessPolicy
        - !Ref CloudFormationPocDynamoDBAccessPolicy
        - !Ref CloudFormationPocCognitoAccessPolicy
        - !Ref CloudFormationPocTransactionsDetailsAccessPolicy
        - !Ref CloudFormationPocLogsDetailsAccessPolicy
        - !Ref CloudFormationPocLogsDetailsBucketAccessPolicy
       
    DependsOn:
      - CloudFormationPocSchedularInvokingEventBridgeAccessPolicy
      - CloudFormationPocDynamoDBAccessPolicy
      - CloudFormationPocCognitoAccessPolicy
      - CloudFormationPocTransactionsDetailsAccessPolicy
      - CloudFormationPocLogsDetailsAccessPolicy
      - CloudFormationPocLogsDetailsBucketAccessPolicy
  
  CloudFormationPocSchedulerExecutionPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Allows the associated Lambda function to manage AWS EventBridge and AWS Scheduler resources
      PolicyDocument:
        Version: 2012-10-17
        Statement:
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:CloudFormationPoc-Service-ProcessSCLUsage

  CloudFormationPocSchedulerAccessRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Join [ "", [ !Ref AWS::Region, CloudFormationPocSchedulerAccessRole] ]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - scheduler.amazonaws.com
            Action:
              - sts:AssumeRole    
            Condition:
              StringEquals:
                aws:SourceAccount: !Sub "${AWS::AccountId}"
      ManagedPolicyArns:
        - !Ref CloudFormationPocSchedulerExecutionPolicy

    DependsOn:
      - CloudFormationPocSchedulerExecutionPolicy
 
  ########################################################################################################################################################
  #                                                                                                                                                      # 
  #                                                        CloudFormationPoc Connect Service API Infrastructure                                                   #
  #                                                                                                                                                      #
  ########################################################################################################################################################
  
  # CloudFormationPoc Service API
  CloudFormationPocServiceApi:
    DependsOn: CognitoUserPool
    Description: A ServerlessApi for CloudFormationPoc Connect Service Portal
    Type: AWS::Serverless::Api
    Properties:
      StageName: v1
      GatewayResponses:
        AUTHORIZER_FAILURE:
          StatusCode: '401'
          ResponseTemplates:
            "application/json": '{"message":"The incoming token has expired"}'
        UNAUTHORIZED:
          StatusCode: '401'
          ResponseTemplates:
            "application/json": '{"message": "Unauthorized"}'
        INTEGRATION_TIMEOUT:
          StatusCode: '202'
          ResponseParameters:
            Headers:
                gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
                gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
                gatewayresponse.header.Access-Control-Allow-Methods: "'*'"
                gatewayresponse.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
                gatewayresponse.response.header.Referrer-Policy: "'no-referrer'"
                gatewayresponse.response.header.X-Frame-Options: "'DENY'"
                gatewayresponse.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
                gatewayresponse.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            "application/json": '{ "status": "PROCESSING", "message": "Please come back with same GUID, it may take some time to process." }'
        EXPIRED_TOKEN:
          StatusCode: '401'
          ResponseParameters:
            Headers:
                gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
                gatewayresponse.header.Access-Control-Allow-Headers: "'*'"
                gatewayresponse.header.Access-Control-Allow-Methods: "'*'"
                gatewayresponse.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
                gatewayresponse.response.header.Referrer-Policy: "'no-referrer'"
                gatewayresponse.response.header.X-Frame-Options: "'DENY'"
                gatewayresponse.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
                gatewayresponse.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            "application/json": '{ "status": "EXPIRED TOKEN", "message":"Access token has expired or is empty." }'
      EndpointConfiguration: REGIONAL
      Name: !Ref ApiName
      Cors:
         AllowMethods: "'*'"
         AllowHeaders: "'*'"
         AllowOrigin: "'*'"
      Auth:
        Authorizers:
           SentinalConnectServiceCognitoAuthorizer:
             UserPoolArn: !GetAtt "CognitoUserPool.Arn"  
           SentinalConnectServiceCognitoCustomAuthorizer:
              FunctionArn:
                Fn::GetAtt:
                 - SentinalConnectServiceCustomAuthorizer
                 - Arn
              FunctionPayloadType: REQUEST
              Identity:
                Headers: 
                  - Authorization
                ReauthorizeEvery: 0
        AddDefaultAuthorizerToCorsPreflight: False
        
  CloudFormationPocServiceApiRequestValidator:
    Type: AWS::ApiGateway::RequestValidator
    Properties:
      Name: Validate body, query string parameters, and headers
      RestApiId: !Ref CloudFormationPocServiceApi
      ValidateRequestBody: true

  CloudFormationPocServiceApiGatewayModel:
    Type: AWS::ApiGateway::Model
    Properties:
      ContentType: 'application/json'
      RestApiId: !Ref CloudFormationPocServiceApi
      Name: CloudFormationPocApiGatewayModel
      Schema: {}

  #CloudFormationPoc Layers
  CustomerAndContactLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes: List
      ContentUri: api/service/layers/CloudFormationPoc-Service-CustomerAndContact
      CompatibleRuntimes:
         - nodejs22.x
      Description: My CloudFormationPoc-Service-CustomerAndContact lamda layers
      LayerName: CloudFormationPoc-Service-CustomerAndContact
      LicenseInfo: "avilable"
      RetentionPolicy: Delete

  DependenciesLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes: List
      ContentUri: api/service/layers/CloudFormationPoc-Service-Dependencies
      CompatibleRuntimes:
         - nodejs22.x
      Description: My lamda CloudFormationPoc-Service-Dependencies layers
      LayerName: CloudFormationPoc-Service-Dependencies
      LicenseInfo: "avilable"
      RetentionPolicy: Delete    

  ServicePartnerLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes: List
      ContentUri: api/service/layers/CloudFormationPoc-Service-Partner
      CompatibleRuntimes:
         - nodejs22.x
      Description: My lamda CloudFormationPoc-Service-Partner layers
      LayerName: CloudFormationPoc-Service-Partner
      LicenseInfo: "avilable"
      RetentionPolicy: Delete    

  ServiceProductLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes: List
      ContentUri: api/service/layers/CloudFormationPoc-Service-Product  
      CompatibleRuntimes:
         - nodejs22.x
      Description: My lamda CloudFormationPoc-Service-Product layers
      LayerName: CloudFormationPoc-Service-Product
      LicenseInfo: "avilable"
      RetentionPolicy: Delete

  CreateProduct:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes: List
      ContentUri: api/service/layers/CloudFormationPoc-Service-CreateProduct
      CompatibleRuntimes:
         - nodejs22.x
      Description: My CloudFormationPoc-Service-CreateProduct lamda layers
      LayerName: CloudFormationPoc-Service-CreateProduct
      LicenseInfo: "avilable"
      RetentionPolicy: Delete

  ServiceCommonLayers:
    Type: AWS::Serverless::LayerVersion
    Properties:
      CompatibleRuntimes: List
      ContentUri: api/service/layers/CloudFormationPoc-Service-CommonLayers
      CompatibleRuntimes:
         - nodejs22.x
      Description: My CloudFormationPoc-Service-CommonLayers lamda layers
      LayerName: CloudFormationPoc-Service-CommonLayers
      LicenseInfo: "avilable"
      RetentionPolicy: Delete

  #CloudFormationPoc Service Lambdas
  CloudFormationPocServiceAuthenticationToken:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/service/Auth/CloudFormationPoc-Service-AuthToken
      FunctionName: CloudFormationPoc-Service-AuthToken
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Environment:
        Variables:
          ClientId: !Ref CognitoUserPoolClient
          UserPoolId: !Ref CognitoUserPool
      Events:     
        token:
           Type: Api
           Properties:
             Path: /token
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: POST

  CloudFormationPocServiceAuthenticationTokenLogGroup: 
    Type: "AWS::Logs::LogGroup"
    Properties: 
       RetentionInDays: 90
       LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServiceAuthenticationToken}"

  CloudFormationPocServiceCreateEntitlement:  
    Type: "AWS::Serverless::Function"
    Properties:
      FunctionName: CloudFormationPoc-Service-CreateEntitlement
      Description: "CloudFormationPocServiceCreateentitlement function"
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-CreateEntitlement
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 256
      Timeout: 120
      Layers:
         - !Ref CustomerAndContactLayer
         - !Ref DependenciesLayer
         - !Ref ServicePartnerLayer
         - !Ref ServiceProductLayer
      Role: !GetAtt CloudFormationPocAccessRole.Arn    
      Environment:
        Variables:
          maxAllowedTotalQuantity: 10

  CloudFormationPocServiceCreateEntitlementLogGroup: 
    Type: "AWS::Logs::LogGroup"
    Properties: 
       RetentionInDays: 90
       LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServiceCreateEntitlement}"
   
  CloudFormationPocServiceExecutionFlow:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-Service-ExecutionFlow
       Description: CloudFormationPocServiceExecutionFlow Function 
       CodeUri: api/service/lambdas/CloudFormationPoc-Service-ExecutionFlow
       MemorySize: 256
       Timeout: 120
       Handler: index.handler
       Runtime: nodejs22.x
       Layers:
         - !Ref CustomerAndContactLayer
         - !Ref DependenciesLayer
         - !Ref ServicePartnerLayer
         - !Ref ServiceProductLayer
         - !Ref ServiceCommonLayers
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn
       Events:
         activation:
           Type: Api
           Properties:
             Path: /activation
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: POST
             RequestParameters:
              - method.request.header.authorization:
                  Required: true
              - method.request.header.guid:
                  Required: true 
             Auth:
               Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
         entitlement:
            Type: Api
            Properties:
              Path: /entitlement
              RestApiId: !Ref CloudFormationPocServiceApi
              Method: GET
              Auth:
                Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
              RequestParameters:
              - method.request.header.authorization:
                  Required: true
              - method.request.header.guid:
                  Required: true  

         POST:
            Type: Api
            Properties:
              Path: /entitlement
              RestApiId: !Ref CloudFormationPocServiceApi
              Method: POST
              Auth:
                Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
              RequestParameters:
              - method.request.header.authorization:
                  Required: true
              - method.request.header.guid:
                  Required: true  
         PUT:
            Type: Api
            Properties:
              Path: /entitlement
              RestApiId: !Ref CloudFormationPocServiceApi
              Method: PUT
              RequestParameters:
              - method.request.header.authorization:
                  Required: true
              - method.request.header.guid:
                  Required: true
              Auth:
                Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
         sync:
            Type: Api
            Properties:
              Path: /sync
              RestApiId: !Ref CloudFormationPocServiceApi
              Method: PATCH
              RequestParameters:
              - method.request.header.authorization:
                  Required: true
              - method.request.header.guid:
                  Required: true
              Auth:
                Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
       Environment:
         Variables:
          ActivateEntitlement: !Ref CloudFormationPocServiceActivateEntitlement
          CreateEntitlement: CloudFormationPoc-Service-CreateEntitlement
          InputValidation: CloudFormationPoc-Service-ValidationEngine
          LogGroupName: CloudFormationPoc
          LogName: CloudFormationPoc
          SoapRequest: /entitlement/soap
          UpdateEntitlement: CloudFormationPoc-Service-UpdateEntitlement
          ValidateAndSaveRequest: CloudFormationPoc-Service-PersistenceEngine
          encryption_key: !Sub '"${EncryptionKey}"'

  CloudFormationPocServiceExecutionFlowLogGroup: 
    Type: "AWS::Logs::LogGroup"
    Properties: 
       RetentionInDays: 90
       LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServiceExecutionFlow}"

  CloudFormationPocServicePersistenceEngine:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-Service-PersistenceEngine
       Description: CloudFormationPoc-Service-PersistenceEngine
       CodeUri: api/service/lambdas/CloudFormationPoc-Service-PersistenceEngine
       MemorySize: 256
       Timeout: 120
       Handler: index.handler
       Runtime: nodejs22.x
       Layers:
         - !Ref DependenciesLayer
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn
       Environment:
         Variables:
            ClientTable: Client
            MessageTable: Message
            MessageTypeExternalIdIndex: MessageType-ExternalId-index
            SystemTable: SystemConfig
            BucketName: !Ref CloudFormationPocTransactionsDetails
            CallOutsTable: CallOuts

  CloudFormationPocServicePersistenceEngineLogGroup: 
    Type: "AWS::Logs::LogGroup"
    Properties: 
       RetentionInDays: 90
       LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServicePersistenceEngine}"

  CloudFormationPocServiceUpdateEntitlement:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-Service-UpdateEntitlement
       Description: CloudFormationPoc-Service-UpdateEntitlement
       CodeUri: api/service/lambdas/CloudFormationPoc-Service-UpdateEntitlement
       MemorySize: 256
       Timeout: 120
       Handler: index.handler
       Runtime: nodejs22.x
       Layers:
         - !Ref DependenciesLayer
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn

  CloudFormationPocServiceUpdateEntitlementLogGroup: 
    Type: "AWS::Logs::LogGroup"
    Properties: 
       RetentionInDays: 90
       LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServiceUpdateEntitlement}"

  CloudFormationPocServiceValidationEngine:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-Service-ValidationEngine
       Description: CloudFormationPoc-Service-ValidationEngine
       CodeUri: api/service/lambdas/CloudFormationPoc-Service-ValidationEngine
       MemorySize: 256
       Timeout: 120
       Handler: index.handler
       Runtime: nodejs22.x
       Layers:
         - !Ref CustomerAndContactLayer
         - !Ref DependenciesLayer
         - !Ref ServicePartnerLayer
         - !Ref ServiceProductLayer
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn

  CloudFormationPocServiceValidationEngineLogGroup: 
    Type: "AWS::Logs::LogGroup"
    Properties: 
       RetentionInDays: 90
       LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServiceValidationEngine}"

  CloudFormationPocServiceQuickTrialStepsHandler:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-Service-QuickTrialStepsHandler
       CodeUri: api/service/lambdas/CloudFormationPoc-Service-QuickTrialStepsHandler
       MemorySize: 128
       Timeout: 20
       Handler: index.handler
       Runtime: nodejs22.x
       Layers:
         - !Ref DependenciesLayer
         - !Ref CreateProduct
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn
       Events:
         quickStartTrialPost:
           Type: Api
           Properties:
             Path: /quick-start-trial
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: POST
             Auth:
               Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
         quickStartTrialGet:
           Type: Api
           Properties:
             Path: /quick-start-trial
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: GET
             Auth:
               Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
         quickStartTrialPut:
           Type: Api
           Properties:
             Path: /quick-start-trial
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: PUT
             Auth:
               Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
         ViewSourceCodeGet:
           Type: Api
           Properties:
             Path: /viewsourcecode
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: GET
             RequestParameters:
                - method.request.querystring.stepstatus
             Auth:
              Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
       Environment:
         Variables:
          UserStatusTable: !Ref QuickTrialUserStatusDynamoDBTable 
          BucketName: !Ref ArtifactsBucketName

  CloudFormationPocServiceQuickTrialStepsHandlerLogGroup: 
    Type: "AWS::Logs::LogGroup"
    Properties: 
       RetentionInDays: 90
       LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServiceQuickTrialStepsHandler}"


  CloudFormationPocServiceOracleProcessEntitlement:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-Service-Oracle-entitlement
       Description: CloudFormationPoc-Service-OracleProcessEntitlement
       CodeUri: api/service/lambdas/CloudFormationPoc-Service-OracleEntitlement
       MemorySize: 128
       Timeout: 20
       Handler: index.handler
       Runtime: nodejs22.x
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn
       Layers:
         - !Ref DependenciesLayer
       Events:
         oracleentitlement:
           Type: Api
           Properties:
             Path: /oracle-entitlement
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: POST
       Environment:
         Variables:
          ClientTable: Client
          Entitlement: CloudFormationPoc-Service-ExecutionFlow
          UserPoolId: !Ref CognitoUserPool

  CloudFormationPocServiceSAPEntitlement:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-Service-SAPEntitlement
       Description: CloudFormationPoc-Service-SAPEntitlement
       CodeUri: api/service/lambdas/CloudFormationPoc-Service-SAPEntitlement
       MemorySize: 256
       Timeout: 120
       Handler: index.handler
       Runtime: nodejs22.x
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn
       Policies: !Ref CloudFormationPocS3EventNotificationAccessPolicy
       Layers:
         - !Ref DependenciesLayer
       Environment:
         Variables:
          ClientTable: Client
          BucketName: !Ref S3EventBucketName
          UserPoolId: !Ref CognitoUserPool
          Entitlement: CloudFormationPoc-Service-ExecutionFlow

  CloudFormationPocServicePrepareMetadata:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-Service-PrepareMetadata
       Description: CloudFormationPoc-Service-PrepareMetadata
       CodeUri: api/service/lambdas/CloudFormationPoc-Service-PrepareMetadata
       MemorySize: 128
       Timeout: 20
       Handler: index.handler
       Runtime: nodejs22.x
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn
       Policies: !Ref CloudFormationPocS3EventNotificationAccessPolicy
       Layers:
         - !Ref DependenciesLayer
       Events:
         MetadataPost:
           Type: Api
           Properties:
             Path: /Metadata
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: POST
             Auth:
               Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
       Environment:
         Variables:
          BucketName: !Ref CloudFormationPocTransactionsDetails
          LogGroupName: CloudFormationPoc
          MessageTable: !Ref MessageDynamoDBTable

  CloudFormationPocServiceZuoraSubscription:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-Service-ZuoraSubscription
       Description: CloudFormationPoc-Service-ZuoraSubscription
       CodeUri: api/service/lambdas/CloudFormationPoc-Service-ZuoraSubscription
       MemorySize: 128
       Timeout: 60
       Handler: index.handler
       Runtime: nodejs22.x
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn
       Policies: !Ref CloudFormationPocS3EventNotificationAccessPolicy
       Layers:
         - !Ref DependenciesLayer
       Events:
         ZuoraSubscriptionPost:
           Type: Api
           Properties:
             Path: /ZuoraSubscription
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: POST
            #  Auth:
            #    Authorizer: NONE  
       Environment:
         Variables:
          BucketName: !Ref S3EventBucketName
          Entitlement: CloudFormationPoc-Service-ExecutionFlow
          UserPoolId: !Ref CognitoUserPool

  CloudFormationPocServiceGetMetadata:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-Service-GetMetadata
       Description: CloudFormationPoc-Service-GetMetadata
       CodeUri: api/service/lambdas/CloudFormationPoc-Service-GetMetadata
       MemorySize: 128
       Timeout: 20
       Handler: index.handler
       Runtime: nodejs22.x
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn
       Policies: !Ref CloudFormationPocS3EventNotificationAccessPolicy
       Layers:
         - !Ref DependenciesLayer
       Events:
         MetadataGET:
           Type: Api
           Properties:
             Path: /Metadata
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: GET
             Auth:
               Authorizer: SentinalConnectServiceCognitoCustomAuthorizer  
       Environment:
         Variables:
          BucketName: !Ref CloudFormationPocTransactionsDetails
          ClientTable: !Ref ClientDynamoDBTable

# SCL related lambdas
  CloudFormationPocServiceSchedulerUpdateStatus:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-SchedulerUpdateStatus
      FunctionName: CloudFormationPoc-Service-SchedulerUpdateStatus
      Description: CloudFormationPoc-Service-SchedulerUpdateStatus
      MemorySize: 128
      Timeout: 20
      Runtime: nodejs22.x
      Handler: index.handler
      Tracing: Active
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Events:
         SchedulerUpdateStatusPOST:
           Type: Api
           Properties:
             Path: /scheduler-update-status
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: POST
             Auth:
               Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
      Environment:
        Variables:
          SchedulerConfigTable: !Ref SchedulerConfigDynamoDBTable

  CloudFormationPocServiceSchedulerUpdateStatusLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServiceSchedulerUpdateStatus}"
      RetentionInDays: 90
                                      
  CloudFormationPocServiceSaveSchedulerConfig:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-SaveSchedulerConfig
      FunctionName: CloudFormationPoc-Service-SaveSchedulerConfig
      Description: CloudFormationPoc-Service-SaveSchedulerConfig
      MemorySize: 128
      Timeout: 20
      Runtime: nodejs22.x
      Handler: index.handler
      Tracing: Active
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Events:
         SchedulerConfigPOST:
           Type: Api
           Properties:
             Path: /scheduler-config
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: POST
             Auth:
               Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
      Environment:
        Variables:
          SchedulerConfigTable: !Ref SchedulerConfigDynamoDBTable
          TargetLambdaARN: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:CloudFormationPoc-Service-ProcessSCLUsage
          ScheduleRuleRoleARN: !Sub arn:aws:iam::${AWS::AccountId}:role/${AWS::Region}CloudFormationPocSchedulerAccessRole

  CloudFormationPocServiceSaveSchedulerConfigLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServiceSaveSchedulerConfig}"
      RetentionInDays: 90

  CloudFormationPocServiceProcessSCLUsage:
    Type: "AWS::Serverless::Function"
    Properties:
      FunctionName: CloudFormationPoc-Service-ProcessSCLUsage
      Description: CloudFormationPoc-Service-ProcessSCLUsage
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-ProcessSCLUsage
      MemorySize: 128
      Timeout: 900
      Runtime: nodejs22.x
      Handler: index.handler
      Tracing: Active
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
         - !Ref ServiceCommonLayers
      Events:
         processclusagePOST:
           Type: Api
           Properties:
             Path: /process-scl-usage
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: POST
             Auth:
               Authorizer: SentinalConnectServiceCognitoCustomAuthorizer   
      Environment:
        Variables:
          SchedulerLogTable: !Ref SchedulerLogDynamoDBTable
          SchedulerConfigTable: !Ref SchedulerConfigDynamoDBTable
          MessageTable: !Ref MessageDynamoDBTable
          ClientTable: !Ref ClientDynamoDBTable
          LogGroupName: CloudFormationPoc

  CloudFormationPocServiceProcessSCLUsageLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServiceProcessSCLUsage}"
      RetentionInDays: 90

  CloudFormationPocServiceGetSchedulerConfig:
    Type: "AWS::Serverless::Function"
    Properties:
      FunctionName: CloudFormationPoc-Service-GetSchedulerConfig
      Description: CloudFormationPoc-Service-GetSchedulerConfig
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-GetSchedulerConfig
      MemorySize: 128
      Timeout: 20
      Runtime: nodejs22.x
      Handler: index.handler
      Tracing: Active
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Events:
         SchedulerConfigGET:
           Type: Api
           Properties:
             Path: /scheduler-config
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: GET
             Auth:
               Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
      Environment:
        Variables:
          SchedulerConfigTable: !Ref SchedulerConfigDynamoDBTable
          SchedulerLogTable: !Ref SchedulerLogDynamoDBTable

  CloudFormationPocServiceGetSchedulerConfigLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties:
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServiceGetSchedulerConfig}"
      RetentionInDays: 90

  CloudFormationPocServiceDeleteSchedulerConfig:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-DeleteSchedulerConfig
      FunctionName: CloudFormationPoc-Service-DeleteSchedulerConfig
      Description: CloudFormationPoc-Service-DeleteSchedulerConfig
      MemorySize: 128
      Timeout: 20
      Runtime: nodejs22.x
      Handler: index.handler
      Tracing: Active
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Events:
         SchedulerConfigDELETE:
           Type: Api
           Properties:
             Path: /scheduler-config
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: DELETE
             Auth:
               Authorizer: SentinalConnectServiceCognitoCustomAuthorizer
      Environment:
        Variables:
          TargetLambdaARN: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:CloudFormationPoc-Service-ProcessSCLUsage  

  CloudFormationPocServiceDeleteSchedulerConfigLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocServiceDeleteSchedulerConfig}"
      RetentionInDays: 90

  CloudFormationPocServiceHealthCheck:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-HealthChecks
      FunctionName: CloudFormationPoc-Service-HealthChecks
      Description: CloudFormationPoc-Service-HealthChecks
      MemorySize: 128
      Timeout: 3
      Runtime: nodejs22.x
      Handler: index.handler
      Tracing: Active
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Events:
         SchedulerConfigGET:
           Type: Api
           Properties:
             Path: /serviceHealthCheck
             RestApiId: !Ref CloudFormationPocServiceApi
             Method: GET

  LambdaAuthorizerFunction:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-SAP-idoc-authorizer
       Description: CloudFormationPoc-SAP-idoc-authorizer
       CodeUri: api/service/lambdas/CloudFormationPoc-SAP-idoc-authorizer
       MemorySize: 128
       Timeout: 20
       Handler: index.handler
       Runtime: nodejs22.x
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn
       Layers:
         - !Ref DependenciesLayer
       Environment:
         Variables:
          BucketName: !Ref S3EventBucketName
          CognitoUserPoolId: !Ref CognitoUserPool
          CognitoUserPoolClientId:   !Ref CognitoUserPoolClient

  LambdaS3AccessFunction:
     Type: 'AWS::Serverless::Function'
     Properties:
       FunctionName: CloudFormationPoc-SAP-IDOC-SAPListener
       Description: CloudFormationPoc-SAP-IDOC-SAPListener
       CodeUri: api/service/lambdas/CloudFormationPoc-SAP-IDOC-SAPListener
       MemorySize: 256
       Timeout: 120
       Handler: index.handler
       Runtime: nodejs22.x
       Tracing: Active
       Role: !GetAtt CloudFormationPocAccessRole.Arn
       Layers:
         - !Ref DependenciesLayer
       Environment:
         Variables:
          BucketName: !Ref S3EventBucketName
          CognitoUserPoolId: !Ref CognitoUserPool
          CognitoUserPoolClientId:   !Ref CognitoUserPoolClient

  AuthorizerLambdaAccess:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - LambdaAuthorizerFunction
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${CloudFormationPocWebPortalRestApi}/authorizers/${IDOCAdapterLambdaAuthorizer}

  S3LambdaAccess:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - LambdaS3AccessFunction
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${CloudFormationPocWebPortalRestApi}/*/*/*


########################################################################
#
#  CloudFormationPoc Cloudwatch Logs Lambda& CloudwatchRule & s3Policy
#
##########################################################################

  CloudFormationPocCloudwatchLogs:
    Type: "AWS::Serverless::Function"
    Properties:
      FunctionName: CloudFormationPoc-Service-Cloudwatch
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-Cloudwatch
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 300
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Environment:
         Variables: 
            BucketName: !Ref CloudWatchLogsBucketName

  CloudFormationPocCloudwatchLogGroup: 
    Type: "AWS::Logs::LogGroup"
    Properties: 
       RetentionInDays: 90
       LogGroupName: !Sub "/aws/lambda/${CloudFormationPocCloudwatchLogs}"

  CloudFormationPocLambdaLogsCloudwatchRule:
    Condition: IsHigherEnv
    Type: AWS::Events::Rule
    Properties: 
      Description: "ScheduledRule"
      ScheduleExpression: cron(0 4 * * ? *)
      State: "ENABLED"
      Targets: 
        - 
          Arn: 
            Fn::GetAtt: 
              - "CloudFormationPocCloudwatchLogs"
              - "Arn"
          Id: "TargetFunction-CloudFormationPocCloudwatchLogs"


  PermissionForEventsToInvokeLambda:
    Condition: IsHigherEnv
    Type: AWS::Lambda::Permission
    Properties: 
      FunctionName: 
        Ref: "CloudFormationPocCloudwatchLogs"
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: 
        Fn::GetAtt: 
          - "CloudFormationPocLambdaLogsCloudwatchRule"
          - "Arn"

  CloudwatchLogsBucketPolicy:
    DependsOn: CloudFormationPocCloudwatchLogsBucket
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CloudFormationPocCloudwatchLogsBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Action:
              - 's3:PutObject'
              - 's3:GetObject'
            Effect: Allow
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref CloudFormationPocCloudwatchLogsBucket
                - /*
            Principal: { "Service": "logs.eu-central-1.amazonaws.com" }
          - Action:
              - 's3:GetBucketAcl'
            Effect: Allow
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref CloudFormationPocCloudwatchLogsBucket
            Principal: { "Service": "logs.eu-central-1.amazonaws.com" }

  CloudFormationPocCloudwatchLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: Private
      BucketName: !Ref CloudWatchLogsBucketName
      LifecycleConfiguration:
        Rules:
          - Id: DeleteLogFilesAfterOneYear
            ExpirationInDays: 365
            Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: "True"
        BlockPublicPolicy: "True"
        IgnorePublicAcls: "True"
        RestrictPublicBuckets: "True"
    DeletionPolicy: Retain
    
  ########################################################################################################################################################
  #                                                                                                                                                      # 
  #                                                        CloudFormationPoc Connect Admin Web UI Infrastructure                                                  #
  #                                                                                                                                                      #
  ########################################################################################################################################################
  CloudFormationPocTransactionsDetails:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref ArtifactsBucketName
      PublicAccessBlockConfiguration:
        BlockPublicAcls: "True"
        BlockPublicPolicy: "True"
        IgnorePublicAcls: "True"
        RestrictPublicBuckets: "True"
    DeletionPolicy: Retain

  CloudFormationPocSAPEntitlement:
    DependsOn: LambdaInvokePermission
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref S3EventBucketName
      NotificationConfiguration:
        LambdaConfigurations:
          - Event: s3:ObjectCreated:*
            Function: !GetAtt [ CloudFormationPocServiceSAPEntitlement, Arn]
      PublicAccessBlockConfiguration:
        BlockPublicAcls: "True"
        BlockPublicPolicy: "True"
        IgnorePublicAcls: "True"
        RestrictPublicBuckets: "True"
    DeletionPolicy: Retain

  LambdaInvokePermission:
    Type: AWS::Lambda::Permission
    DependsOn: CloudFormationPocServiceSAPEntitlement
    Properties:
      FunctionName:
        Fn::GetAtt:
          - CloudFormationPocServiceSAPEntitlement
          - Arn
      Action: lambda:InvokeFunction
      Principal: s3.amazonaws.com
      SourceArn:
        Fn::Sub: arn:aws:s3:::${S3EventBucketName}

  CloudFormationPocStoreChartDataScheduledRule: 
    Type: AWS::Events::Rule
    Properties: 
      Description: "Store Dashboards data lambda hourly trigger"
      ScheduleExpression: "rate(1 hour)"
      State: "ENABLED"
      Targets: 
        - 
           Arn: 
             Fn::GetAtt: 
               - "CloudFormationPocWebStoreChartData"
               - "Arn"
           Id: "TargetFunction-StoreChartData"

  #Web UI API Gateway - CloudFormationPocWeb
  CloudFormationPocWebPortalRestApi:
   Type: "AWS::ApiGateway::RestApi"
   Properties:
     Name: CloudFormationPocWeb
     Description: A REST API for CloudFormationPoc Connect Admin Portal
     FailOnWarnings: true
     EndpointConfiguration:
       Types:
         - REGIONAL 
  
  # Authorizer
  CloudFormationPocWebCognitoAuthorizer:
     Type: AWS::ApiGateway::Authorizer
     Properties:
       Name: CloudFormationPocWebAuthorizer
       Type: COGNITO_USER_POOLS
       IdentitySource: method.request.header.authorization
       ProviderARNs:
        - Fn::GetAtt:
            - CognitoUserPool
            - Arn
       RestApiId: !Ref CloudFormationPocWebPortalRestApi

  IDOCAdapterLambdaAuthorizer:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      Name: IDOC_Adapter_Authorizer
      Type: REQUEST
      AuthorizerResultTtlInSeconds: 0
      AuthorizerUri: !Sub 
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "LambdaAuthorizerFunction.Arn"
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      IdentitySource: "method.request.header.Authorization"

        # Create a mock GET method for the IDOCAdapterAPI
  IDOCMockGet:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref SAPResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref IDOCAdapterLambdaAuthorizer
      Integration:
          Type: MOCK
          PassthroughBehavior: WHEN_NO_MATCH
          IntegrationResponses:
          - ResponseTemplates:
              application/json: '{"statusCode": 200,"message:": "IDOC Adapter Connection Works!"}'
            StatusCode: '200'
          RequestTemplates:
            application/json: '{"statusCode": 200}'
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }

  IDOCMockPost:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref SAPResource
      HttpMethod: POST
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref IDOCAdapterLambdaAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "LambdaS3AccessFunction.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200

  
  #Client Resource
  ClientsResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'clients'

        #Client Resource
  SAPResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'SAPResource'

  CustomAttributesResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'customAttributes'

  #Client Resource Methods
  ClientsMethodGet:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref ClientsResource
      HttpMethod: GET
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebListClients.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES     
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$')}"
                  ]
               ]
            }  
          }

  ClientsMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: ClientsResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false

  ClientsMethodPost:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref ClientsResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebCreateClient.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$')}"
                  ]
               ]
            }
          }

  CustomAttributesMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: CustomAttributesResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false

  CustomAttributesMethodPost:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref CustomAttributesResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebGetCustomAttributes.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$'),\n",
                    "\n    \"selectedClient\": \"$input.params(\"client\")\"}"
                  ]
               ]
            }
          }
          
  #Client/verifyemsdetails Resource
  VerifyEMSDetailsResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !Ref ClientsResource
      PathPart: 'verifyemsdetails'

  #Client/verifyemsdetails Resource Methods
  VerifyEMSDetailsMethodPost:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref VerifyEMSDetailsResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebVerifyClientEMSDetails.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$')}"
                  ]
               ]
            }
          }

  VerifyEMSDetailsMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: VerifyEMSDetailsResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false

  #Dashboards Resource
  DashboardsResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'dashboards'

  #Dashboard Resource Methods
  DashboardsMethodGet:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref DashboardsResource
      HttpMethod: GET 
      RequestParameters:
        method.request.querystring.timeStamp: true
        method.request.querystring.client: true
        method.request.querystring.date: true
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebGetChartData.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$'),\n",
                    "\n    \"selectedClient\": \"$input.params(\"client\")\",\n",
                    "\n    \"selectedDate\": \"$input.params(\"date\")\",\n",
                    "\n    \"timeStamp\": \"$input.params(\"timeStamp\")\"}"
                  ]
               ]
            }
          }

  DashboardsMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: DashboardsResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false

  #Token Resource
  TokenResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'token'

  #Token Resource Methods
  TokenMethodPost:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref TokenResource
      HttpMethod: POST
      AuthorizationType: NONE
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocAuthenticationToken.Arn"
        PassthroughBehavior: WHEN_NO_MATCH
        IntegrationResponses:
          - StatusCode: 200             

  #Transactions Resource
  TransactionsResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'transactions'
  #Transaction Resource Methods
  TransactionsMethodGet:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref TransactionsResource
      HttpMethod: GET
      RequestParameters:
        method.request.querystring.timestamp: true
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebListTransactions.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$'),\n",
                    "\n    \"time\": \"$input.params(\"timeStamp\")\"}"
                  ]
               ]
            }
          }

  TransactionsMethodPost:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref TransactionsResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebListTransactions.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$')}"
                  ]
               ]
            }
          }

  TranasctionsMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: TransactionsResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:          
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false
 
  # Transactions/Logs Resource
  TranasctionLogsResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !Ref TransactionsResource
      PathPart: 'logs'
  # Transactions/Logs Resource Methods
  TranasctionLogsMethodPost:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref TranasctionLogsResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebTransactionLogs.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$')}"
                  ]
               ]
            }
          }

  TranasctionLogsMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: TranasctionLogsResource
      AuthorizationType: NONE      
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false

  #Users Resource
  UsersResources:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'users'
  #Users Resource Methods
  UsersMethodDelete:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref UsersResources
      HttpMethod: DELETE
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebDeleteUser.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$')}"
                  ]
               ]
            }
          }

  UsersMethodGet:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref UsersResources
      HttpMethod: GET
      RequestParameters:
        method.request.querystring.client: true
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebListUsers.Arn"  
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$'),\n",
                    "\n    \"selectedClient\": \"$input.params(\"client\")\"}"
                  ]
               ]
            }
          }

  UsersMethodPost:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref UsersResources
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebCreateUser.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$')}"
                  ]
               ]
            }
          }

  UsersMethodPut:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref UsersResources
      HttpMethod: PUT
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebUpdateUser.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$')}"
                  ]
               ]
            }
          }

  UsersMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: UsersResources
      AuthorizationType: NONE 
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false
  CalloutsResources:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'callouts'
  #Callouts Resource Methods
  CalloutsMethodDelete:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref CalloutsResources
      HttpMethod: DELETE
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebDeleteCallouts.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$'),\n",
                    "\n    \"selectedClient\": \"$input.params(\"client\")\"}"
                  ]
               ]
            }
          }

  CalloutMethodGet:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref CalloutsResources
      HttpMethod: GET
      RequestParameters:
        method.request.querystring.client: true
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebGetCallouts.Arn"  
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$'),\n",
                    "\n    \"selectedClient\": \"$input.params(\"client\")\"}"
                  ]
               ]
            }
          }

  CalloutsMethodPost:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref CalloutsResources
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebSaveCallouts.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$')}"
                  ]
               ]
            }
          }

  CalloutsMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: CalloutsResources
      AuthorizationType: NONE 
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false

  VerifyCalloutResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !Ref CalloutsResources
      PathPart: 'verifyCallout'

  VerifyCalloutMethodPost:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref VerifyCalloutResource
      HttpMethod: POST
      AuthorizationType: COGNITO_USER_POOLS
      AuthorizerId: !Ref CloudFormationPocWebCognitoAuthorizer
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebVerifyCallout.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"
        "RequestTemplates": {
          "application/json": {
              "Fn::Join": [
                  "",
                  [
                    "{\n    \"method\": \"$context.httpMethod\",\n",
                    "\n    \"claimsSub\": \"$context.authorizer.claims.sub\",\n",
                    "\n    \"claimsUsername\": \"$context.authorizer.claims[\"cognito:username\"]\",\n",
                    "\n    \"claimsRole\": \"$context.authorizer.claims[\"custom:Role\"]\",\n",
                    "\n    \"claimsClientId\": \"$context.authorizer.claims[\"custom:ClientId\"]\",\n",
                    "\n    \"body\": $input.json('$')}"
                  ]
               ]
            }
          }

  VerifyCalloutMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: VerifyCalloutResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'POST,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false
  #Swagger Resource
  SwaggerResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'swagger'

  SwaggerMethodGet:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref SwaggerResource
      HttpMethod: GET
      AuthorizationType: NONE
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebSwaggerAPI.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES     
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"

  SwaggerMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: SwaggerResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,POST,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        PassthroughBehavior: WHEN_NO_MATCH
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false   

 #QuickTrialSignup Resource
  QuickTrialSignupResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'quicktrialsignup'

  #QuickTrialSignup Resource Methods
  QuickTrialSignupMethodPost:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref QuickTrialSignupResource
      AuthorizationType: NONE 
      HttpMethod: POST
      MethodResponses:
         - StatusCode: 200
           ResponseModels: { "application/json": "Empty" }
           ResponseParameters:
              method.response.header.Access-Control-Allow-Origin: true
              method.response.header.Permissions-Policy: true
              method.response.header.Strict-Transport-Security: true
              method.response.header.Referrer-Policy: true
              method.response.header.X-Frame-Options: true
              method.response.header.Content-Security-Policy: true
              method.response.header.X-Content-Type-Options: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebSignupQuickTrialUsers.Arn"
        PassthroughBehavior: WHEN_NO_TEMPLATES
        IntegrationResponses:
          - ResponseTemplates:
              application/json: ''
            StatusCode: 200
            ResponseParameters:          
              method.response.header.Access-Control-Allow-Origin: "'*'"
              method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
              method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
              method.response.header.Referrer-Policy: "'no-referrer'"
              method.response.header.X-Frame-Options: "'DENY'"
              method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
              method.response.header.X-Content-Type-Options: "'nosniff'"

  QuickTrialSignupMethodOptions:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: QuickTrialSignupResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false

  processentitlementResource:
    Condition: IsHigherEnv
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'processentitlement'

  #QuickTrialSignup Resource Methods
  processentitlementMethodOptions:
    Condition: IsHigherEnv
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: processentitlementResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false


  idocmetadataResource:
    Condition: IsHigherEnv
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'idocmetadata'

  #QuickTrialSignup Resource Methods
  idocmetadataResourceMethodOptions:
    Condition: IsHigherEnv
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: idocmetadataResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false

  OracleMetadataResource:
    Condition: IsHigherEnv
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'OracleMetadata'

  #QuickTrialSignup Resource Methods
  OracleMetadataResourceMethodOptions:
    Condition: IsHigherEnv
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: OracleMetadataResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false

  OracleEntitlementResource:
    Condition: IsHigherEnv
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'OracleEntitlement'

  #QuickTrialSignup Resource Methods       
  OracleEntitlementResourceMethodOptions:
    Condition: IsHigherEnv
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId:
        Ref: CloudFormationPocWebPortalRestApi
      ResourceId:
        Ref: OracleEntitlementResource
      AuthorizationType: NONE
      HttpMethod: OPTIONS
      Integration:
        IntegrationResponses:
        - StatusCode: 200
          ResponseParameters:
            method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,authorization,X-Api-Key,X-Amz-Security-Token'"
            method.response.header.Access-Control-Allow-Methods: "'GET,OPTIONS'"
            method.response.header.Access-Control-Allow-Origin: "'*'"
            method.response.header.Permissions-Policy: "'accelerometer=(), ambient-light-sensor=(), autoplay=(), battery=(), camera=(), cross-origin-isolated=(), display-capture=(), document-domain=(), encrypted-media=(), execution-while-not-rendered=(), execution-while-out-of-viewport=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), navigation-override=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=(), clipboard-read=*, clipboard-write=*, gamepad=(), speaker-selection=(), conversion-measurement=(), focus-without-user-activation=(), hid=(), idle-detection=(), interest-cohort=(), serial=(), sync-script=(), trust-token-redemption=(), window-placement=(), vertical-scroll=()'"
            method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubDomains;'"
            method.response.header.Referrer-Policy: "'no-referrer'"
            method.response.header.X-Frame-Options: "'DENY'"
            method.response.header.Content-Security-Policy: "'frame-ancestors 'none';'"
            method.response.header.X-Content-Type-Options: "'nosniff'"
          ResponseTemplates:
            application/json: ''
        RequestTemplates:
          application/json: '{statusCode: 200}'
        Type: MOCK
      MethodResponses:
      - StatusCode: 200
        ResponseModels:
          application/json: 'Empty'
        ResponseParameters:
          method.response.header.Access-Control-Allow-Headers: false
          method.response.header.Access-Control-Allow-Methods: false
          method.response.header.Access-Control-Allow-Origin: false
          method.response.header.Permissions-Policy: false
          method.response.header.Strict-Transport-Security: false
          method.response.header.Referrer-Policy: false
          method.response.header.X-Frame-Options: false
          method.response.header.Content-Security-Policy: false
          method.response.header.X-Content-Type-Options: false

  HealthCheckResource:
    Type: 'AWS::ApiGateway::Resource'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ParentId: !GetAtt 
        - CloudFormationPocWebPortalRestApi
        - RootResourceId
      PathPart: 'webHealthCheck'

  HealthCheckMethodGet:
    DependsOn: CloudFormationPocWebPortalRestApi
    Type: 'AWS::ApiGateway::Method'
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      ResourceId: !Ref HealthCheckResource
      AuthorizationType: NONE 
      HttpMethod: GET
      MethodResponses:
         - StatusCode: 200
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub
          - "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${lambdaArn}/invocations"
          - lambdaArn: !GetAtt "CloudFormationPocWebHealthCheck.Arn"

  #Api Gateway Deployment
  CloudFormationPocApiGatewayDeployment:
    Condition: IsHigherEnv   
    Type: 'AWS::ApiGateway::Deployment'
    DependsOn:
      -  CloudFormationPocWebPortalRestApi
      -  ClientsMethodGet
      -  ClientsMethodOptions
      -  ClientsMethodPost
      -  VerifyEMSDetailsMethodPost
      -  VerifyEMSDetailsMethodOptions
      -  DashboardsMethodGet
      -  DashboardsMethodOptions
      -  TokenMethodPost
      -  TransactionsMethodGet
      -  TransactionsMethodPost
      -  TranasctionsMethodOptions
      -  TranasctionLogsMethodPost
      -  TranasctionLogsMethodOptions
      -  UsersMethodDelete
      -  UsersMethodGet
      -  UsersMethodPost
      -  UsersMethodPut
      -  UsersMethodOptions
      -  CalloutsMethodPost
      -  CalloutMethodGet
      -  CalloutsMethodDelete
      -  CalloutsMethodOptions
      -  VerifyCalloutMethodOptions
      -  VerifyCalloutMethodPost
      -  SwaggerMethodGet
      -  SwaggerMethodOptions
      -  QuickTrialSignupMethodPost
      -  QuickTrialSignupMethodOptions
      -  processentitlementResource
      -  processentitlementMethodOptions
      -  idocmetadataResource
      -  idocmetadataResourceMethodOptions
      -  IDOCMockGet
      -  IDOCMockPost
      -  HealthCheckMethodGet
      -  CustomAttributesMethodOptions
      -  CustomAttributesMethodPost
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      StageName: !Ref AdminWebApiGatewayStageName
      Description: "QA Deployment testing"

  CloudFormationPocApiGatewayDeployment:
    Condition: IsLowerEnv
    Type: 'AWS::ApiGateway::Deployment'
    DependsOn:
      -  CloudFormationPocWebPortalRestApi
      -  ClientsMethodGet
      -  ClientsMethodOptions
      -  ClientsMethodPost
      -  VerifyEMSDetailsMethodPost
      -  VerifyEMSDetailsMethodOptions
      -  DashboardsMethodGet
      -  DashboardsMethodOptions
      -  TokenMethodPost
      -  TransactionsMethodGet
      -  TransactionsMethodPost
      -  TranasctionsMethodOptions
      -  TranasctionLogsMethodPost
      -  TranasctionLogsMethodOptions
      -  UsersMethodDelete
      -  UsersMethodGet
      -  UsersMethodPost                                                       
      -  UsersMethodPut
      -  UsersMethodOptions
      -  CalloutsMethodPost
      -  CalloutMethodGet
      -  CalloutsMethodOptions
      -  CalloutsMethodDelete
      -  VerifyCalloutMethodOptions
      -  VerifyCalloutMethodPost
      -  SwaggerMethodGet
      -  SwaggerMethodOptions
      -  QuickTrialSignupMethodPost
      -  QuickTrialSignupMethodOptions
      -  IDOCMockGet
      -  IDOCMockPost
      -  HealthCheckMethodGet
      -  CustomAttributesMethodOptions
      -  CustomAttributesMethodPost
    Properties:
      RestApiId: !Ref CloudFormationPocWebPortalRestApi
      StageName: !Ref AdminWebApiGatewayStageName
      Description: "QA Deployment testing"
   
  #Web UI Lambdas
  CloudFormationPocWebListClients:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-ListClients
      FunctionName: CloudFormationPoc-Web-ListClients
      Description: CloudFormationPoc-Web-ListClients Function
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 256
      Timeout: 120
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer

  CloudFormationPocWebListClientsLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebListClients}"
      RetentionInDays: 90
      
  CloudFormationPocWebListClientsPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebListClients
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/GET/clients"
        ]
      ]

  CloudFormationPocWebVerifyClientEMSDetails:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-VerifyClientEMSDetails
      FunctionName: CloudFormationPoc-Web-VerifyClientEMSDetails
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer

  CloudFormationPocWebVerifyClientEMSDetailsLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebVerifyClientEMSDetails}"
      RetentionInDays: 90

  CloudFormationPocWebVerifyClientEMSDetailsPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebVerifyClientEMSDetails
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/POST/clients/verifyemsdetails"
        ]
      ]

  CloudFormationPocWebGetChartData:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-GetChartData
      FunctionName: CloudFormationPoc-Web-GetChartData
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 30
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Environment:
        Variables:
          BucketName: !Ref CloudFormationPocTransactionsDetails

  CloudFormationPocWebGetChartDataLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      RetentionInDays: 90
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebGetChartData}"

  CloudFormationPocWebGetChartDataPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebGetChartData
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/GET/dashboards"
        ]
      ]

  CloudFormationPocWebStoreChartData:
    Type: "AWS::Serverless::Function"
    Properties:
      FunctionName: CloudFormationPoc-Web-StoreChartData
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-StoreChartData
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 300
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Environment:
        Variables:
          BucketName: !Ref CloudFormationPocTransactionsDetails

  CloudFormationPocWebStoreChartDataLogGroup: 
    Type: "AWS::Logs::LogGroup"
    Properties: 
       RetentionInDays: 90
       LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebStoreChartData}"

  CloudFormationPocWebStoreChartDataPermissions: 
    Type: AWS::Lambda::Permission
    Properties: 
      FunctionName: !Ref "CloudFormationPocWebStoreChartData"
      Action: "lambda:InvokeFunction"
      Principal: "events.amazonaws.com"
      SourceArn: 
        Fn::GetAtt: 
         - "CloudFormationPocStoreChartDataScheduledRule"
         - "Arn"

  CloudFormationPocWebListTransactions:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-ListTransactions
      FunctionName: CloudFormationPoc-Web-ListTransactions
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 256
      Timeout: 120
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer

  CloudFormationPocWebListTransactionsLogGroup: 
    Type: "AWS::Logs::LogGroup"
    Properties: 
       RetentionInDays: 90
       LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebListTransactions}"

  CloudFormationPocWebListTransactionsPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebListTransactions
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/GET/transactions"
        ]
      ]

  CloudFormationPocWebListTransactionsPermissionsPost:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebListTransactions
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/POST/transactions"
        ]
      ]

  CloudFormationPocWebTransactionLogs:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-TransactionLogs
      FunctionName: CloudFormationPoc-Web-TransactionLogs
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 900
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Environment:
        Variables:
          LogGroupName: CloudFormationPoc
          BucketName: !Ref CloudFormationPocTransactionsDetails

  CloudFormationPocWebTransactionLogsLogGroup: 
    Type: "AWS::Logs::LogGroup"
    Properties: 
       LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebTransactionLogs}"
       RetentionInDays: 90

  CloudFormationPocWebTransactionLogsPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebTransactionLogs
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/POST/transactions/logs"
        ]
      ]

  CloudFormationPocWebCreateClient:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-CreateClient
      FunctionName: CloudFormationPoc-Web-CreateClient
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Environment:
        Variables:
          ClientId: !Ref CloudFormationPocCognitoOpenIdClient
          UserPoolId: !Ref CognitoUserPool
          
  CloudFormationPocWebCreateClientLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      RetentionInDays: 90
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebCreateClient}"

  CloudFormationPocWebCreateClientPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebCreateClient
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/POST/clients"
        ]
      ]

  CloudFormationPocWebCreateUser:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-CreateUser
      FunctionName: CloudFormationPoc-Web-CreateUser
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Environment:
        Variables:
          ClientId: !Ref CognitoUserPoolClient
          UserPoolId: !Ref CognitoUserPool

  CloudFormationPocWebCreateUserLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebCreateUser}"
      RetentionInDays: 90

  CloudFormationPocWebCreateUserPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebCreateUser
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/POST/users"
        ]
      ]

  CloudFormationPocWebDeleteUser:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-DeleteUser
      FunctionName: CloudFormationPoc-Web-DeleteUser
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15 
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Environment:
        Variables:
          ClientTable: Client
          ServiceAccountIdIndex: Region-ServiceAccountId-index
          userPoolId: !Ref CognitoUserPool

  CloudFormationPocWebDeleteUserLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebDeleteUser}"
      RetentionInDays: 90

  CloudFormationPocWebDeleteUserPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebDeleteUser
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/DELETE/users"
        ]
      ]

  CloudFormationPocWebUpdateUser:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-UpdateUser
      FunctionName: CloudFormationPoc-Web-UpdateUser
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer 
      Environment:
        Variables:
          UserPoolId: !Ref CognitoUserPool

  CloudFormationPocWebUpdateUserLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebUpdateUser}"
      RetentionInDays: 90

  CloudFormationPocWebUpdateUserPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebUpdateUser
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/PUT/users"
        ]
      ]

  CloudFormationPocWebListUsers:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-ListUsers
      FunctionName: CloudFormationPoc-Web-ListUsers
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Environment:
        Variables:
          UserPoolId: !Ref CognitoUserPool

  CloudFormationPocWebListUsersLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebListUsers}"
      RetentionInDays: 90

  CloudFormationPocWebListUsersPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebListUsers
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/GET/users"
        ]
      ]

  CloudFormationPocWebSignupQuickTrialUsers:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-SignUpQuickTrialUsers  
      FunctionName: CloudFormationPoc-Web-SignupQuickTrialUsers
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Environment:
        Variables:
          CreateUserFunction: !Ref CloudFormationPocWebCreateUser
          CreateClientFunction: !Ref CloudFormationPocWebCreateClient
          UserPoolId: !Ref CognitoUserPool 
          AppClientId:  !Ref CognitoUserPoolClient
          UserStatusTable: !Ref QuickTrialUserStatusDynamoDBTable
          BucketName: !Ref CloudFormationPocTransactionsDetails

  CloudFormationPocWebSignupQuickTrialUsersLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebSignupQuickTrialUsers}"
      RetentionInDays: 90

  CloudFormationPocWebSignupQuickTrialUsersPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebSignupQuickTrialUsers
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/POST/quicktrialsignup"
        ]
      ]

  #Web Token
  CloudFormationPocAuthenticationToken:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/misc/CloudFormationPoc-Authentication-Token
      FunctionName: CloudFormationPoc-Authentication-Token
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Environment:
        Variables:
          UserPoolId: !Ref CognitoUserPool 
          ClientId: !Ref CognitoUserPoolClient

  CloudFormationPocAuthenticationTokenLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocAuthenticationToken}"
      RetentionInDays: 90
     
  CloudFormationPocAuthenticationTokenPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocAuthenticationToken
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/POST/token"
        ]
      ]

  #Swagger
  CloudFormationPocWebSwaggerAPI:
    Type: "AWS::Serverless::Function"
    Properties:
      FunctionName: CloudFormationPoc-Web-SwaggerAPI
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-SwaggerAPI
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Environment:
        Variables:
          Endpoint: !Ref CloudFormationPocServiceApiCustomURL
          EnviromentDescription: v1 Environment
          Version: v1

  CloudFormationPocWebSwaggerAPILogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebSwaggerAPI}"
      RetentionInDays: 90

  CloudFormationPocSwaggerAPIPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebSwaggerAPI
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/GET/swagger"
        ]
      ]

  CloudFormationPocWebHealthCheck:
    Type: "AWS::Serverless::Function"
    Properties:
      FunctionName: CloudFormationPoc-Web-HealthChecks
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-HealthChecks
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 3
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Environment:
        Variables:
          webHostName: !Ref WebHostName

  CloudFormationPocWebHealthCheckPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebHealthCheck
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/GET/webHealthCheck"
        ]
      ]


  #CloudFormationPoc Connect Default Admin User
  CloudFormationPocSAMCreateAdmin:
    Type: "AWS::Serverless::Function"
    Properties:
      FunctionName: CloudFormationPoc-SAM-CreateAdmin
      CodeUri: api/misc/CloudFormationPoc-SAM-CreateAdmin
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 300
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer

  CloudFormationPocSAMCreateAdminLogGroup:
    Condition: IsHigherEnv
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocSAMCreateAdmin}"
      RetentionInDays: 90
 
  CloudFormationPocSAMCreateAdminLambdaInvoker:
    Type: Custom::LambdaInvoker
    DependsOn: CloudFormationPocSAMCreateAdmin
    Version: "1.0"
    Properties:
       ServiceToken: !GetAtt CloudFormationPocSAMCreateAdmin.Arn
       body:
         {
             "UserPoolId": !Ref CognitoUserPool,
             "UserName": !Ref UserName,
             "Email": !Ref Email,
             "Phone": !Ref PhoneNo,
             "Name": !Ref Name,
             "TableName": SystemConfig,
             "BucketName": !Ref CloudFormationPocTransactionsDetails,
             "FunctionName": !Ref CloudFormationPocWebStoreChartData,
             "Region": !Ref AWS::Region,
             "Account": !Ref AWS::AccountId,
             "Name": !Ref AWS::AccountId
         }

  CloudFormationPocServiceOracleEntitlement:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-OracleEntitlement
      FunctionName: CloudFormationPoc-Service-OracleEntitlement
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer
      Environment:
        Variables:
          BucketName: !Ref CloudFormationPocTransactionsDetails

  CloudFormationPocServiceOracleEntitlementPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocServiceOracleEntitlement
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/POST/oracle-entitlement"
        ]
      ]

  CloudFormationPocWebSaveCallouts:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-SaveCallouts
      FunctionName: CloudFormationPoc-Web-SaveCallouts
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 65
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
        - !Ref DependenciesLayer
      Environment:
        Variables:
          CALLOUT_TABLE: CallOuts
          encryption_key: !Sub '"${EncryptionKey}"'

  CloudFormationPocWebSaveCalloutsLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebSaveCallouts}"
      RetentionInDays: 90

  CloudFormationPocWebSaveCalloutsPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebSaveCallouts
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/POST/callouts"
        ]
      ]

  CloudFormationPocWebGetCallouts:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-GetCallouts
      FunctionName: CloudFormationPoc-Web-GetCallouts
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 65
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
        - !Ref DependenciesLayer
      Environment:
        Variables:
          CALLOUT_TABLE: CallOuts

  CloudFormationPocWebGetCalloutsLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebGetCallouts}"
      RetentionInDays: 90

  CloudFormationPocWebGetCalloutsPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebGetCallouts
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/GET/callouts"
        ]
      ]

  CloudFormationPocWebDeleteCallouts:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-DeleteCallout
      FunctionName: CloudFormationPoc-Web-DeleteCallouts
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 65
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
        - !Ref DependenciesLayer
      Environment:
        Variables:
          CALLOUT_TABLE: CallOuts

  CloudFormationPocWebDeleteCalloutsLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebDeleteCallouts}"
      RetentionInDays: 90

  CloudFormationPocWebDeleteCalloutsPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebDeleteCallouts
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/DELETE/callouts"
        ]
      ]
  CloudFormationPocWebVerifyCallout:
    Type: "AWS::Serverless::Function"
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-VerifyCalloutURL
      FunctionName: CloudFormationPoc-Web-VerifyCalloutURL
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 15
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
         - !Ref DependenciesLayer

  CloudFormationPocWebVerifyCalloutLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebVerifyCallout}"
      RetentionInDays: 90

  CloudFormationPocWebVerifyCalloutPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebVerifyCallout
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/POST/callouts/verifyCallout"
        ]
      ]
      
  SentinalConnectServiceCustomAuthorizer:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: api/service/Auth/CloudFormationPoc-Service-CustomAuthorizer
      FunctionName: SentinalConnect-Service-CustomAuthorizer
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 60
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
        - !Ref DependenciesLayer
      Environment:
        Variables:
          UserPoolId: !Ref CognitoUserPool 
      
  CloudFormationPocServicePostDeployement:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-PostDeployement
      FunctionName: CloudFormationPoc-Service-PostDeployement
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 60
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
        - !Ref DependenciesLayer
      Environment:
        Variables:
          ClientId: !Ref CloudFormationPocCognitoOpenIdClient
          UserPoolId: !Ref CognitoUserPool
          
  CloudFormationPocServicePostDeployementLambdaInvoker:
    Type: Custom::LambdaInvoker
    DependsOn: CloudFormationPocServicePostDeployement
    Version: "1.0"
    Properties:
       ServiceToken: !GetAtt CloudFormationPocServicePostDeployement.Arn
       body:
         {
             "key1": "value",
             "key2": "value1" 
         }

  CloudFormationPocServiceActivateEntitlement:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-ActivateEntitlement
      FunctionName: CloudFormationPoc-Service-ActivateEntitlement
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 256
      Timeout: 120
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
        - !Ref DependenciesLayer

  CloudFormationPocWebGetCustomAttributes:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: api/web/lambdas/CloudFormationPoc-Web-GetCustomAttributes
      FunctionName: CloudFormationPoc-Web-GetCustomAttributes
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 65
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
        - !Ref DependenciesLayer
      Environment:
        Variables:
          CLIENT_TABLE: Client
          encryption_key: !Sub '"${EncryptionKey}"'

  CloudFormationPocWebGetCustomAttributesLogGroup:
    Type: "AWS::Logs::LogGroup"
    Properties: 
      RetentionInDays: 90
      LogGroupName: !Sub "/aws/lambda/${CloudFormationPocWebGetCustomAttributes}"

  CloudFormationPocWebGetCustomAttributesPermissions:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !GetAtt
        - CloudFormationPocWebGetCustomAttributes
        - Arn
      Principal: apigateway.amazonaws.com
      SourceArn: !Join [
        "", [
          "arn:aws:execute-api:",
          {"Ref": "AWS::Region"}, ":",
          {"Ref": "AWS::AccountId"}, ":",
          !Ref CloudFormationPocWebPortalRestApi, "/*/POST/customAttributes"
        ]
      ]

  CloudFormationPocServiceUpdateCognito:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: api/service/lambdas/CloudFormationPoc-Service-UpdateCognito
      FunctionName: CloudFormationPoc-Service-UpdateCognito
      Handler: index.handler
      Runtime: nodejs22.x
      MemorySize: 128
      Timeout: 60
      Role: !GetAtt CloudFormationPocAccessRole.Arn
      Layers:
        - !Ref DependenciesLayer
      Environment:
        Variables:
          CLIENT_ID: !Ref CloudFormationPocCognitoOpenIdClient
          USER_POOL_ID: !Ref CognitoUserPool   
          Refresh_Token_Expiration: !Ref RefreshTokenExpirationInDays
          AccessToken_Token_Expiration: !Ref AccessTokenExpirationInHours
          IdToken_Token_Expiration: !Ref IdTokenExpirationInHours

  CloudFormationPocServiceUpdateCognitoLambdaInvoker:
    Type: Custom::LambdaInvoker
    DependsOn: CloudFormationPocServiceUpdateCognito
    Version: "1.0"
    Properties:
       ServiceToken: !GetAtt CloudFormationPocServiceUpdateCognito.Arn
       body:
         Refresh_Token_Expiration: !Ref RefreshTokenExpirationInDays
         AccessToken_Token_Expiration: !Ref AccessTokenExpirationInHours
         IdToken_Token_Expiration: !Ref IdTokenExpirationInHours

  ########################################################################################################################################################
  #                                                                                                                                                      # 
  #                                                        CloudFormationPoc Connect Outputs                                                                      #
  #                                                                                                                                                      #
  ########################################################################################################################################################
  
Outputs:
  Region:
    Description: "Region"
    Value: !Ref AWS::Region

  CognitoUserPoolId:
    Description: "Cognito User Pool Id"
    Value: !Ref CognitoUserPool

  CognitoUserPoolClientId:
    Description: "Cognito User Pool Client Id"
    Value: !Ref CognitoUserPoolClient
